global
    log stdout format raw local0
    maxconn 4096
    stats socket /var/run/haproxy.sock mode 600 level admin
    stats timeout 2m

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client 60s
    timeout server 60s
    timeout http-request 10s
    timeout http-keep-alive 2s

# Stats page
frontend stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 5s
    stats show-legends
    stats show-node

# Main frontend - accepts Git protocol requests
frontend git_proxy
    bind *:8080
    default_backend goblet_shards

    # Capture the request path for routing
    http-request set-header X-Request-Path %[path]

    # Log backend selection
    http-request capture path len 256
    http-response set-header X-Served-By %[srv_name]

# Backend with consistent hashing by URL path
# This ensures the same repository always goes to the same instance
backend goblet_shards
    balance uri whole
    hash-type consistent

    # Health checks
    option httpchk GET /healthz
    http-check expect status 200

    # Servers (Goblet instances)
    server goblet-1 goblet-1:8080 check inter 5s fall 3 rise 2
    server goblet-2 goblet-2:8080 check inter 5s fall 3 rise 2
    server goblet-3 goblet-3:8080 check inter 5s fall 3 rise 2

    # Connection tuning for Git operations
    timeout server 300s
    timeout connect 10s

    # Retry policy - don't retry on same server to avoid corruption
    retries 0
